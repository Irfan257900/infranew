name: Deploy Azure VM and Configure SQL

on:
  workflow_dispatch:

env:
  RG_NAME: rg-Voltica-tst-vm
  VM_NAME: Volticatstsql
  SQL_ADMIN_USER: Volticatstadmin
  PROJECT_NAME: infranew

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Initialize Terraform
        working-directory: ./terraform
        run: terraform init

      - name: Validate Terraform
        working-directory: ./terraform
        run: terraform validate

      - name: Apply Terraform
        working-directory: ./terraform
        run: terraform apply -auto-approve

      # ================================
      # CONFIGURE SQL INSIDE VM
      # ================================
      - name: Configure SQL Database inside VM
        shell: pwsh
        env:
          RG_NAME: ${{ env.RG_NAME }}
          VM_NAME: ${{ env.VM_NAME }}
          SQL_ADMIN_USER: ${{ env.SQL_ADMIN_USER }}
          SQL_ADMIN_PASS: ${{ secrets.VM_ADMIN_PASSWORD }}
          SQL_APP_PASS: ${{ secrets.APP_SQL_PASSWORD }}
        run: |
          echo "=== Starting SQL Database configuration inside VM ==="

          # Create PowerShell script dynamically
          $script = @"
          param(
              [string]\$SqlAdminUser,
              [string]\$SqlAdminPass,
              [string]\$SqlAppPass
          )

          \$ErrorActionPreference = 'Stop'
          Write-Host '=== Configuring SQL Server... ==='

          Start-Sleep -Seconds 20
          Restart-Service -Name 'MSSQLSERVER' -Force
          Start-Sleep -Seconds 20

          sqlcmd -S localhost -U \$SqlAdminUser -P \$SqlAdminPass -Q "CREATE DATABASE VolticaDB"
          sqlcmd -S localhost -U \$SqlAdminUser -P \$SqlAdminPass -Q "CREATE LOGIN VolticaApp WITH PASSWORD='\$SqlAppPass', CHECK_POLICY=OFF; CREATE USER VolticaApp FOR LOGIN VolticaApp; ALTER ROLE db_owner ADD MEMBER VolticaApp;"

          Write-Host '✅ SQL setup completed successfully.'
          "@

          Set-Content -Path "db_setup.ps1" -Value $script -Force

          # Retry logic for VM run-command
          for ($i = 1; $i -le 10; $i++) {
            echo "Attempt $i to run SQL setup script on VM..."
            $result = az vm run-command invoke `
              --resource-group $env:RG_NAME `
              --name $env:VM_NAME `
              --command-id RunPowerShellScript `
              --scripts @"db_setup.ps1" `
              --parameters "SqlAdminUser=$env:SQL_ADMIN_USER" "SqlAdminPass=$env:SQL_ADMIN_PASS" "SqlAppPass=$env:SQL_APP_PASS" 2>&1

            if ($LASTEXITCODE -eq 0) {
              echo "✅ SQL setup completed successfully."
              break
            } else {
              echo "⚠️ VM RunCommand busy — waiting 30s before retry ($i/10)..."
              Start-Sleep -Seconds 30
            }
          }

          if ($LASTEXITCODE -ne 0) {
            echo "❌ SQL setup failed after 10 attempts — VM still busy."
            exit 1
          }
