- name: Create and Run SQL Database Script
  if: success()
  env:
    SQL_ADMIN_PASS: ${{ secrets.VM_ADMIN_PASSWORD }}
    SQL_APP_PASS: ${{ secrets.APP_SQL_PASSWORD }}
    SQL_ADMIN_USER: "Volticatstadmin"
    RG_NAME: "rg-Voltica-tst-vm"
    VM_NAME: "Volticatstsql"
  shell: bash 
  run: |
    echo "Creating PowerShell script to configure SQL..."
    
    cat > db_setup.ps1 <<'EOF'
    param(
        [string]$SqlAdminUser,
        [string]$SqlAdminPass,
        [string]$SqlAppPass
    )
    
    Write-Host "Starting SQL configuration..."
    Write-Host "Admin User: $SqlAdminUser"
    
    $sql = @"
    IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'VolticaDB')
    BEGIN
        CREATE DATABASE VolticaDB;
        PRINT 'Database VolticaDB created.';
    END
    ELSE
    BEGIN
        PRINT 'Database VolticaDB already exists.';
    END
    
    IF NOT EXISTS (SELECT name FROM sys.server_principals WHERE name = N'voltica_app_user')
    BEGIN
        CREATE LOGIN voltica_app_user WITH PASSWORD = '$SqlAppPass';
        PRINT 'Login voltica_app_user created.';
    END
    ELSE
    BEGIN
        PRINT 'Login voltica_app_user already exists.';
    END
    
    USE VolticaDB;
    
    IF NOT EXISTS (SELECT name FROM sys.database_principals WHERE name = N'voltica_app_user')
    BEGIN
        CREATE USER voltica_app_user FOR LOGIN voltica_app_user;
        ALTER ROLE db_owner ADD MEMBER voltica_app_user;
        PRINT 'User voltica_app_user created and added to db_owner role.';
    END
    ELSE
    BEGIN
        PRINT 'User voltica_app_user already exists.';
    END
    "@
    
    try {
        Write-Host "Importing SqlServer module..."
        Import-Module SqlServer -ErrorAction Stop
        
        Write-Host "Executing SQL commands..."
        Invoke-Sqlcmd -Query $sql -ServerInstance "localhost" -Username $SqlAdminUser -Password $SqlAdminPass -Verbose
        
        Write-Host "✅ SQL configuration completed successfully."
        exit 0
    }
    catch {
        Write-Host "❌ SQL configuration failed: $($_.Exception.Message)"
        Write-Host "Stack Trace: $($_.Exception.StackTrace)"
        exit 1
    }
    EOF
    
    echo "Script created successfully"
    
    az vm run-command invoke \
      --resource-group "$RG_NAME" \
      --name "$VM_NAME" \
      --command-id RunPowerShellScript \
      --scripts @db_setup.ps1 \
      --parameters "SqlAdminUser=${SQL_ADMIN_USER}" "SqlAdminPass=${SQL_ADMIN_PASS}" "SqlAppPass=${SQL_APP_PASS}"
