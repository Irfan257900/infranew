name: Deploy Azure VM + SQL Setup

on:
  workflow_dispatch:

env:
  RG_NAME: rg-Voltica-tst-vm
  VM_NAME: Volticatstsql
  SQL_ADMIN_USER: Volticatstadmin
  PROJECT_NAME: infranew

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploying Azure infrastructure...
        run: |
          echo "Starting Terraform apply..."
          terraform init
          terraform apply -auto-approve
        env:
          RG_NAME: ${{ env.RG_NAME }}
          VM_NAME: ${{ env.VM_NAME }}
          SQL_ADMIN_USER: ${{ env.SQL_ADMIN_USER }}

      - name: Wait for Azure API to stabilize and send IP to Zapier
        run: |
          echo "Waiting 30 seconds for Azure API to stabilize..."
          sleep 30

          echo "Fetching NIC and Public IP..."
          NIC_ID=$(az vm show -g $RG_NAME -n $VM_NAME --query "networkProfile.networkInterfaces[0].id" -o tsv)
          echo "NIC ID: $NIC_ID"

          if [ -z "$NIC_ID" ]; then
            echo "❌ NIC ID not found — VM may not have finished provisioning."
            exit 1
          fi

          PIP_ID=$(az network nic show --ids $NIC_ID --query "ipConfigurations[0].publicIpAddress.id" -o tsv)
          echo "Public IP ID: $PIP_ID"

          if [ -z "$PIP_ID" ]; then
            echo "❌ Public IP not attached to NIC."
            exit 1
          fi

          VM_PUBLIC_IP=$(az network public-ip show --ids $PIP_ID --query "ipAddress" -o tsv)
          echo "✅ Detected IP: $VM_PUBLIC_IP"

          VM_URL="http://$VM_PUBLIC_IP"
          JSON_PAYLOAD=$(jq -n \
            --arg projectName "$PROJECT_NAME" \
            --arg appServiceUrl "$VM_URL" \
            --arg appServiceIp "$VM_PUBLIC_IP" \
            --arg ownerEmail "irfanmd2579@gmail.com" \
            '{projectName:$projectName, appServiceUrl:$appServiceUrl, appServiceIp:$appServiceIp, ownerEmail:$ownerEmail}')

          echo "Sending payload to Zapier..."
          curl -X POST "$ZAPIER_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
        env:
          ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}
          RG_NAME: ${{ env.RG_NAME }}
          VM_NAME: ${{ env.VM_NAME }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}

      - name: Configure SQL Server via PowerShell
        run: |
          echo "Creating PowerShell script for SQL configuration..."
          cat > db_setup.ps1 <<'EOF'
          param(
              [string]$SqlAdminUser,
              [string]$SqlAdminPass,
              [string]$SqlAppPass
          )

          Write-Host "Configuring SQL Server user and permissions..."

          $connectionString = "Server=localhost;Database=master;User Id=$SqlAdminUser;Password=$SqlAdminPass;"
          $query = @"
          CREATE LOGIN AppLogin WITH PASSWORD = '$SqlAppPass';
          CREATE USER AppUser FOR LOGIN AppLogin;
          EXEC sp_addrolemember 'db_owner', 'AppUser';
          "@
          sqlcmd -S localhost -U $SqlAdminUser -P $SqlAdminPass -Q $query
          EOF

          echo "Running SQL setup script remotely on VM..."
          az vm run-command invoke \
            --command-id RunPowerShellScript \
            --name $VM_NAME \
            --resource-group $RG_NAME \
            --scripts "@db_setup.ps1" \
            --parameters SqlAdminUser=$SQL_ADMIN_USER SqlAdminPass=${{ secrets.SQL_ADMIN_PASS }} SqlAppPass=${{ secrets.SQL_APP_PASS }}
        env:
          RG_NAME: ${{ env.RG_NAME }}
          VM_NAME: ${{ env.VM_NAME }}
          SQL_ADMIN_USER: ${{ env.SQL_ADMIN_USER }}
          SQL_ADMIN_PASS: ${{ secrets.SQL_ADMIN_PASS }}
          SQL_APP_PASS: ${{ secrets.SQL_APP_PASS }}
