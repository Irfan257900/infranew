name: Deploy TST Environment

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./environments/tst

    steps:
      - name: Check out the repository code
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Clear local Terraform cache and Lock File
        run: |
          echo "Removing .terraform directory..."
          rm -rf .terraform
          echo "Removing .terraform.lock.hcl file..."
          rm -f .terraform.lock.hcl

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        timeout-minutes: 30
        env:
          TF_VAR_vm_admin_password: ${{ secrets.VM_ADMIN_PASSWORD }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        timeout-minutes: 90
        run: terraform apply -auto-approve tfplan

      - name: Wait for VM to be ready
        run: |
          echo "Waiting 3 minutes for VM extensions to finish..."
          sleep 180

      - name: Configure SQL Server Database
        if: success()
        env:
          SQL_ADMIN_USER: "Volticatstadmin"
          SQL_ADMIN_PASS: ${{ secrets.VM_ADMIN_PASSWORD }}
          SQL_APP_PASS: ${{ secrets.APP_SQL_PASSWORD }}
          RG_NAME: "rg-Voltica-tst-vm"
          VM_NAME: "Volticatstsql"
        shell: pwsh
        run: |
          echo "=== Starting SQL Database configuration inside VM ==="

          # Install required Azure PowerShell module
          Install-Module -Name Az.Compute -Force -AllowClobber -Scope CurrentUser

          # Define the PowerShell script that runs inside the VM
          $scriptBlock = @"
          Write-Host '========================================='
          Write-Host 'üöÄ Starting SQL Server Database Setup'
          Write-Host '========================================='
          try {
              Write-Host 'Installing SqlServer module...'
              Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
              Import-Module SqlServer

              Write-Host 'Step 1: Create database VolticaDB...'
              \$createDbQuery = @"
                IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'VolticaDB')
                BEGIN
                    CREATE DATABASE VolticaDB;
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createDbQuery

              Write-Host 'Step 2: Create login voltica_app_user...'
              \$createLoginQuery = @"
                IF NOT EXISTS (SELECT name FROM sys.server_principals WHERE name = N'voltica_app_user')
                BEGIN
                    CREATE LOGIN voltica_app_user WITH PASSWORD = '$($env:SQL_APP_PASS)';
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createLoginQuery

              Write-Host 'Step 3: Create DB user and assign permissions...'
              \$createUserQuery = @"
                USE VolticaDB;
                IF NOT EXISTS (SELECT name FROM sys.database_principals WHERE name = N'voltica_app_user')
                BEGIN
                    CREATE USER voltica_app_user FOR LOGIN voltica_app_user;
                    ALTER ROLE db_owner ADD MEMBER voltica_app_user;
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createUserQuery

              Write-Host 'Step 4: Seed sample data...'
              \$seedQuery = @"
                USE VolticaDB;
                IF OBJECT_ID('dbo.AppLogs', 'U') IS NULL
                BEGIN
                    CREATE TABLE dbo.AppLogs (
                        LogId INT IDENTITY(1,1) PRIMARY KEY,
                        Message NVARCHAR(255),
                        CreatedAt DATETIME DEFAULT GETDATE()
                    );
                    INSERT INTO dbo.AppLogs (Message) VALUES ('Database initialized');
                END
                ELSE
                BEGIN
                    INSERT INTO dbo.AppLogs (Message) VALUES ('Reconfiguration completed');
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$seedQuery

              Write-Host '‚úÖ SQL configuration complete!'
          }
          catch {
              Write-Host "‚ùå Error: $($_.Exception.Message)"
              exit 1
          }
          "@

          # --- Run Command with Retry Mechanism ---
          $maxAttempts = 10
          $attempt = 1
          $success = $false

          while (-not $success -and $attempt -le $maxAttempts) {
              Write-Host "Attempt $attempt to run SQL setup script on VM..."
              try {
                  Invoke-AzVMRunCommand `
                    -ResourceGroupName $env:RG_NAME `
                    -VMName $env:VM_NAME `
                    -CommandId 'RunPowerShellScript' `
                    -ScriptString $scriptBlock
                  $success = $true
                  Write-Host "‚úÖ SQL setup succeeded on attempt $attempt"
              }
              catch {
                  if ($_.Exception.Message -like "*Run command extension execution is in progress*") {
                      Write-Host "‚ö†Ô∏è VM RunCommand busy ‚Äî waiting 30s before retry ($attempt/$maxAttempts)..."
                      Start-Sleep -Seconds 30
                      $attempt++
                  } else {
                      Write-Host "‚ùå Unexpected error: $($_.Exception.Message)"
                      exit 1
                  }
              }
          }

          if (-not $success) {
              Write-Host "‚ùå SQL setup failed after $maxAttempts attempts ‚Äî VM still busy."
              exit 1
          }

      - name: Trigger Post-Deployment Automation
        if: success()
        env:
          ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}
          RG_NAME: "rg-Voltica-tst-vm"
          VM_NAME: "Volticatstsql"
        shell: bash
        run: |
          echo "Waiting 30 seconds for Azure API to stabilize..."
          sleep 30
          
          echo "Gathering dynamic data for Zapier..."
          
          PROJECT_NAME="${{ github.event.repository.name }}"
          NIC_ID=$(az vm show -g $RG_NAME -n $VM_NAME --query "networkProfile.networkInterfaces[0].id" -o tsv)
          PIP_ID=$(az network nic show --ids $NIC_ID --query "ipConfigurations[0].publicIpAddress.id" -o tsv)
          VM_PUBLIC_IP=$(az network public-ip show --ids $PIP_ID --query "ipAddress" -o tsv)
          VM_URL="http://$VM_PUBLIC_IP"

          echo "Dynamic Data Found: IP=$VM_PUBLIC_IP, URL=$VM_URL"

          JSON_PAYLOAD=$(cat <<EOF
          {
            "projectName": "$PROJECT_NAME",
            "appServiceUrl": "$VM_URL", 
            "appServiceIp": "$VM_PUBLIC_IP",
            "ownerEmail": "irfanmd2579@gmail.com"
          }
          EOF
          )

          echo "Sending payload to Zapier..."
          curl -X POST "$ZAPIER_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
