name: Deploy Azure Resources and Configure SQL DB

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RG_NAME: rg-Voltica-tst-vm
  VM_NAME: Volticatstsql
  SQL_ADMIN_USER: Volticatstadmin

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 1Ô∏è‚É£ Login to Azure
      # -------------------------------
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -------------------------------
      # 2Ô∏è‚É£ Deploy Azure resources (Terraform or ARM/Bicep)
      # -------------------------------
      - name: Deploy infrastructure (Terraform)
        run: |
          echo "Deploying Azure infrastructure..."
          terraform init
          terraform apply -auto-approve

      # -------------------------------
      # 3Ô∏è‚É£ Configure SQL Database inside VM
      # -------------------------------
      - name: Configure SQL Server Database
        if: success()
        shell: pwsh
        env:
          SQL_ADMIN_USER: ${{ env.SQL_ADMIN_USER }}
          SQL_ADMIN_PASS: ${{ secrets.VM_ADMIN_PASSWORD }}
          SQL_APP_PASS: ${{ secrets.APP_SQL_PASSWORD }}
          RG_NAME: ${{ env.RG_NAME }}
          VM_NAME: ${{ env.VM_NAME }}
        run: |
          echo "=== Starting SQL Database configuration inside VM ==="

          # Ensure required modules
          Install-Module -Name Az.Compute -Force -AllowClobber -Scope CurrentUser

          # --- Wait until VM RunCommand extension is idle ---
          $maxWaitMinutes = 15
          $elapsed = 0
          $ready = $false

          Write-Host "Checking VM RunCommand extension status..."
          while (-not $ready -and $elapsed -lt $maxWaitMinutes) {
              $extStatus = az vm get-instance-view `
                --resource-group $env:RG_NAME `
                --name $env:VM_NAME `
                --query "instanceView.extensions[?name=='RunCommandWindows'] | [0].statuses[0].displayStatus" `
                -o tsv 2>$null

              if ($extStatus -eq "Provisioning succeeded" -or [string]::IsNullOrEmpty($extStatus)) {
                  Write-Host "‚úÖ VM extension is idle. Proceeding..."
                  $ready = $true
              }
              else {
                  Write-Host "‚öôÔ∏è  VM extension busy ($extStatus) ‚Äî waiting 30s..."
                  Start-Sleep -Seconds 30
                  $elapsed += 0.5
              }
          }

          if (-not $ready) {
              Write-Host "‚ùå VM extension still busy after $maxWaitMinutes minutes."
              exit 1
          }

          # --- SQL Setup Script ---
          $scriptBlock = @"
          Write-Host '========================================='
          Write-Host 'üöÄ Starting SQL Server Database Setup'
          Write-Host '========================================='
          try {
              Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
              Import-Module SqlServer

              Write-Host 'Creating DB VolticaDB...'
              \$createDbQuery = @"
                IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'VolticaDB')
                BEGIN
                    CREATE DATABASE VolticaDB;
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createDbQuery

              Write-Host 'Creating login voltica_app_user...'
              \$createLoginQuery = @"
                IF NOT EXISTS (SELECT name FROM sys.server_principals WHERE name = N'voltica_app_user')
                BEGIN
                    CREATE LOGIN voltica_app_user WITH PASSWORD = '$($env:SQL_APP_PASS)';
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createLoginQuery

              Write-Host 'Creating user in VolticaDB...'
              \$createUserQuery = @"
                USE VolticaDB;
                IF NOT EXISTS (SELECT name FROM sys.database_principals WHERE name = N'voltica_app_user')
                BEGIN
                    CREATE USER voltica_app_user FOR LOGIN voltica_app_user;
                    ALTER ROLE db_owner ADD MEMBER voltica_app_user;
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$createUserQuery

              Write-Host 'Creating sample table...'
              \$seedQuery = @"
                USE VolticaDB;
                IF OBJECT_ID('dbo.AppLogs', 'U') IS NULL
                BEGIN
                    CREATE TABLE dbo.AppLogs (
                        LogId INT IDENTITY(1,1) PRIMARY KEY,
                        Message NVARCHAR(255),
                        CreatedAt DATETIME DEFAULT GETDATE()
                    );
                    INSERT INTO dbo.AppLogs (Message) VALUES ('Database initialized');
                END
              "@
              Invoke-Sqlcmd -ServerInstance 'localhost' -Username '$($env:SQL_ADMIN_USER)' -Password '$($env:SQL_ADMIN_PASS)' -Query \$seedQuery

              Write-Host '‚úÖ SQL configuration complete!'
          }
          catch {
              Write-Host "‚ùå Error: $($_.Exception.Message)"
              exit 1
          }
          "@

          # --- Run inside VM ---
          Invoke-AzVMRunCommand `
            -ResourceGroupName $env:RG_NAME `
            -VMName $env:VM_NAME `
            -CommandId 'RunPowerShellScript' `
            -ScriptString $scriptBlock
